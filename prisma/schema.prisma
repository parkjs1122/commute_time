generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String       @id @default(cuid())
  email        String       @unique
  passwordHash String
  name         String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  savedRoutes  SavedRoute[]
}

model SavedRoute {
  id            String     @id @default(cuid())
  userId        String
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  alias         String
  isDefault     Boolean    @default(false)
  routeType     String     @default("commute") // "commute" | "return" | "other"

  // 출발지
  originName    String
  originAddress String
  originLat     Float
  originLng     Float

  // 목적지
  destName      String
  destAddress   String
  destLat       Float
  destLng       Float

  // 경로 요약
  totalTime     Int        // 총 소요 시간 (분)
  transferCount Int        // 환승 횟수
  fare          Int?       // 예상 요금 (원)
  routeSource   String?    // "in_local" | "inter_local" (시내/시외 구분)

  legs          RouteLeg[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([userId])
}

model RouteLeg {
  id             String     @id @default(cuid())
  savedRouteId   String
  savedRoute     SavedRoute @relation(fields: [savedRouteId], references: [id], onDelete: Cascade)
  order          Int        // Leg 순서 (0부터)

  type           String     // "bus" | "subway" | "walk"
  lineNames      String[]   @default([])  // 노선 번호/이름 배열
  lineColor      String?    // 노선 색상
  startStation   String?    // 승차 정류장
  endStation     String?    // 하차 정류장
  startStationId    String?    // 공공데이터 정류장 ID (버스: mobileNo, 지하철: 역명)
  gyeonggiStationId String?    // 경기도 버스 내부 정류소 ID (lazy 영속화, resolveGyeonggiStationId 결과)
  stationCount   Int?       // 정차 역 수
  sectionTime    Int        // 구간 소요 시간 (분)
  distance       Int?       // 구간 거리 (미터)
  legSubType     String?    // "intercity_bus" | "express_bus" (시외/고속버스 구분)

  @@index([savedRouteId])
}

model BusTerminal {
  id          String   @id @default(cuid())
  terminalId  String   @unique    // API terminalId (예: "NAI0511601")
  terminalNm  String              // 터미널 이름 (예: "동서울")
  cityCode    String              // 도시 코드 (예: "11")
  cityName    String              // 도시명 (예: "서울특별시")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([cityCode])
  @@index([terminalNm])
}

model RouteCache {
  id        String   @id @default(cuid())
  originKey String   // "lat,lng" 형태
  destKey   String   // "lat,lng" 형태
  routeData Json     // TransitRoute[] JSON
  createdAt DateTime @default(now())
  expiresAt DateTime // 캐시 만료 (기본 24시간)

  @@unique([originKey, destKey])
  @@index([expiresAt])
}
